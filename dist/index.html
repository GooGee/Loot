<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ark Survival Evolved Loot Editor</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="app.css">
    <script src="crate.js"></script>
    <script src="bag.js"></script>
    <script src="item.js"></script>
    <script src="loot.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.js"></script>
</head>

<body style="padding-top: 55px;">

<template id="tttBag">
    <div>
        <div class="col-sm-8">
            <table class="table table-bordered">
                <caption>
                    <h3>{{bag.name}}</h3>
                </caption>
                <thead>
                    <tr>
                        <th class="col-sm-1"></th>
                        <th class="col-sm-3">Name</th>
                        <th class="col-sm-2">Weight</th>
                        <th class="col-sm-2">Min Quantity</th>
                        <th class="col-sm-2">Max Quantity</th>
                        <th class="col-sm-2">Blueprint Chance</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in bag.entry.list">
                        <td>
                            <button v-on:click="remove(item)" class="btn btn-danger">X</button>
                        </td>
                        <td>{{item.name}}</td>
                        <td>
                            <input v-model.number="item.weight" type="number" min="10" step="10" class="form-control">
                        </td>
                        <td>
                            <input v-model.number="item.min" type="number" min="1" class="form-control">
                        </td>
                        <td>
                            <input v-model.number="item.max" type="number" min="1" class="form-control">
                        </td>
                        <td>
                            <input v-if="1==item.blueprint" v-model.number="item.chance" type="number" step="0.1" min="0" max="1" class="form-control">
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td>
                            <button v-on:click="change('weight')" class="btn btn-info">Set</button>
                        </td>
                        <td>
                            <button v-on:click="change('min')" class="btn btn-info">Set</button>
                        </td>
                        <td>
                            <button v-on:click="change('max')" class="btn btn-info">Set</button>
                        </td>
                        <td>
                            <button v-on:click="changeChance" class="btn btn-info">Set</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="col-sm-4">
            <ul class="list-group">
                <li class="list-group-item">
                    <div class="form-inline">
                        <span>Category:</span>
                        <select v-model="ItemFilter.kind" class="form-control">
                            <option v-for="name in ItemFilter.kindList" v-bind:value="name">{{name}}</option>
                        </select>
                        <button v-on:click="addAll" class="btn btn-info">+ All</button>
                    </div>
                </li>
                <li v-for="item in ItemFilter.list" class="list-group-item">
                    <button v-on:click="add(item)" class="btn btn-info btn-sm">+</button> {{item.name}}
                    <span v-if="2==item.map" class="label label-warning">SE</span>
                    <span v-if="3==item.map" class="label label-success">A</span>
                    <span v-if="item.custom" class="label label-danger">C</span>
                </li>
            </ul>
        </div>
    </div>
</template>

<script>
    
Vue.component('ccc-bag', {
    template: '#tttBag',
    props: ['game', 'bag'],
    data: function () {
        return {
            ItemFilter: ItemFilter
        };
    },
    methods: {
        add: function (item) {
            let iii = this.bag.entry.create();
            iii.load(item);
            this.bag.entry.push(iii);
        },
        remove: function (item) {
            if (confirm('Are you sure?')) {
                this.bag.entry.remove(item);
            }
        },
        addAll: function () {
            let array = ItemFilter.list;
            for (let index = 0; index < array.length; index++) {
                this.add(array[index]);
            }
        },
        change: function (key) {
            let string = prompt('Please enter a number', 1);
            let amount = parseInt(string);
            if (amount >= 1) {
                let array = this.bag.entry.list;
                for (let index = 0; index < array.length; index++) {
                    const item = array[index];
                    item[key] = amount;
                }
            }
        },
        changeChance: function () {
            let string = prompt('Please enter a number between 0 and 1', 0.5);
            let amount = parseFloat(string);
            if (amount >= 0 && amount <= 1) {
                let array = this.bag.entry.list;
                for (let index = 0; index < array.length; index++) {
                    const item = array[index];
                    if (item.blueprint) {
                        item['chance'] = amount;
                    }
                }
            }
        }
    }
});

</script>

<template id="tttBagList">
    <div class="col-sm-12">
        <table class="table table-bordered">
            <caption>
                <h3>ItemSet List</h3>
            </caption>
            <thead>
                <tr>
                    <th class="col-sm-1"></th>
                    <th class="col-sm-2">Name</th>
                    <th class="col-sm-1">Min Items</th>
                    <th class="col-sm-1">Max Items</th>
                    <th class="col-sm-3">Item List</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="bag in game.bag.list">
                    <td>
                        <button v-on:click="remove(bag)" class="btn btn-danger">X</button>
                    </td>
                    <td>
                        <input v-model="bag.name" type="text" class="form-control">
                    </td>
                    <td>
                        <input v-model.number="bag.min" type="number" min="1" class="form-control">
                    </td>
                    <td>
                        <input v-model.number="bag.max" type="number" min="1" class="form-control">
                    </td>
                    <td class="form-inline">
                        <div class="pull-right">
                            <button v-on:click="edit(bag)" class="btn btn-primary">Edit</button>
                        </div>
                        <ul>
                            <li v-for="item in bag.entry.list">{{item.name}}</li>
                        </ul>
                        <div class="clearfix"></div>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td colspan="4">
                        <button v-on:click="add" class="btn btn-primary">+</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</template>

<script>
    
Vue.component('ccc-bag-list', {
    template: '#tttBagList',
    props: ['game'],
    methods: {
        add: function () {
            let name = prompt('Please enter the name');
            if (name) {
                let bag = this.game.bag.create();
                bag.name = name;
                this.game.bag.push(bag);
            }
        },
        remove: function (bag) {
            if (confirm('Are you sure?')) {
                this.game.bag.remove(bag);
            }
        },
        edit: function (bag) {
            BagEH.$emit('edit', bag);
        }
    }
});

</script>

<template id="tttChoose">
    <ccc-dialogue small="small">
        <template slot="header">
            <h4>{{choose.message}}</h3>
        </template>
        <template slot="body">
            <select v-model="choose.item" class="form-control">
                <option v-for="item in choose.list" v-bind:value="item">{{item.name}}</option>
            </select>
        </template>
        <template slot="footer">
            <button v-on:click="yes" class="btn btn-success" type="button">V</button>
            <button v-on:click="no" class="btn btn-danger" type="button">X</button>
        </template>
    </ccc-dialogue>
</template>

<script>
    
const Choose = {
    visible: false,
    message: 'Please choose one',
    item: null,
    list: [],
    yesCB: null,
    noCB: null
};

function showChoose(data) {
    Choose.item = null;
    Choose.yesCB = null;
    Choose.noCB = null;
    for (const key in data) {
        if (data.hasOwnProperty(key)) {
            Choose[key] = data[key];
        }
    }
    Choose.visible = true;
}

Vue.component('ccc-choose', {
    template: '#tttChoose',
    props: ['choose'],
    methods: {
        yes: function () {
            if ('function' == typeof this.choose.yesCB) {
                this.choose.yesCB(this.choose.item);
            }
            this.choose.visible = false;
        },
        no: function () {
            if ('function' == typeof this.choose.noCB) {
                this.choose.noCB(this.choose.item);
            }
            this.choose.visible = false;
        }
    }
});

</script>

<template id="tttCrate">
    <div>
        <div class="col-sm-9">
            <h3>{{crate.name}}</h3>
            <table v-if="crate.custom" class="table table-bordered">
                <tr>
                    <td>Name</td>
                    <td><input v-model.number="crate.name" type="text" class="form-control"></td>
                </tr>
                <tr>
                    <td>Class</td>
                    <td><input v-model.number="crate.class" type="text" class="form-control"></td>
                </tr>
            </table>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="col-sm-1"></th>
                        <th class="col-sm-2">Name</th>
                        <th class="col-sm-2">Weight</th>
                        <th class="col-sm-2">Min Items</th>
                        <th class="col-sm-2">Max Items</th>
                        <th class="col-sm-3">Item List</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="bag in crate.bag.list">
                        <td>
                            <button v-on:click="remove(bag)" class="btn btn-danger">X</button>
                        </td>
                        <td>{{bag.name}}</td>
                        <td>
                            <input v-model.number="bag.weight" type="number" min="10" step="10" class="form-control">
                        </td>
                        <td>
                            <input v-model.number="bag.min" type="number" min="1" class="form-control">
                        </td>
                        <td>
                            <input v-model.number="bag.max" type="number" min="1" class="form-control">
                        </td>
                        <td>
                            <ul>
                                <li v-for="item in bag.entry.list">{{item.name}}</li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="col-sm-3">
            <ul class="list-group">
                <li class="list-group-item">ItemSet List</li>
                <li v-for="bag in game.bag.list" class="list-group-item">
                    <button v-on:click="add(bag)" class="btn btn-info btn-sm">+</button> {{bag.name}}
                </li>
            </ul>
        </div>
    </div>
</template>

<script>
    
Vue.component('ccc-crate', {
    template: '#tttCrate',
    props: ['game', 'crate'],
    methods: {
        add: function (bag) {
            let bbb = this.crate.bag.create();
            bbb.load(bag);
            this.crate.bag.push(bbb);
        },
        remove: function (crate) {
            if (confirm('Are you sure?')) {
                this.crate.bag.remove(crate);
            }
        }
    }
});

</script>
<template id="tttCrateList">
    <div class="col-sm-12">
        <table class="table table-bordered">
            <caption>
                <h3>
                    <span>Crate List</span>
                    <label class="btn btn-info">Load
                        <input v-on:change="load($event)" type="file" accept=".json" style="display:none;">
                    </label>
                    <button v-on:click="save" class="btn btn-success">Save</button>
                    <button v-on:click="deploy" class="btn btn-success">Deploy</button>
                </h3>
            </caption>
            <thead>
                <tr>
                    <th class="col-sm-3">
                        <div class="form-inline">
                            <span>Name</span>
                            <select v-model="kind" class="form-control pull-right">
                                <option v-for="name in kindList" v-bind:value="name">{{name}}</option>
                            </select>
                            <div class="clearfix"></div>
                        </div>
                    </th>
                    <th class="col-sm-1">Include</th>
                    <th class="col-sm-1">Disable</th>
                    <th class="col-sm-1">Min ItemSets</th>
                    <th class="col-sm-1">Max ItemSets</th>
                    <th class="col-sm-5">ItemSet List</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="crate in list">
                    <td>
                        <span>{{crate.name}}</span>
                        <button v-if="crate.custom" v-on:click="remove(crate)" class="btn btn-danger btn-sm">X</button>
                    </td>
                    <td>
                        <label>
                            <input v-model="crate.included" type="checkbox" class="big-checkbox">
                        </label>
                    </td>
                    <td>
                        <label>
                            <input v-model="crate.disabled" type="checkbox" class="big-checkbox">
                        </label>
                    </td>
                    <td>
                        <input v-model.number="crate.min" type="number" min="1" class="form-control">
                    </td>
                    <td>
                        <input v-model.number="crate.max" type="number" min="1" class="form-control">
                    </td>
                    <td>
                        <div class="pull-right">
                            <button v-on:click="edit(crate)" class="btn btn-primary">Edit</button>
                            <button v-on:click="copy(crate)" class="btn btn-info">From</button>
                        </div>
                        <ul>
                            <li v-for="bag in crate.bag.list">{{bag.name}}</li>
                        </ul>
                        <div class="clearfix"></div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button v-on:click="add" class="btn btn-primary">+</button>
                    </td>
                    <td>
                        <button v-on:click="include" class="btn btn-info">All</button>
                    </td>
                    <td>
                        <button v-on:click="disable" class="btn btn-info">All</button>
                    </td>
                    <td>
                        <button v-on:click="change('min')" class="btn btn-info">Set</button>
                    </td>
                    <td>
                        <button v-on:click="change('max')" class="btn btn-info">Set</button>
                    </td>
                    <td>
                        <button v-on:click="update" class="btn btn-info">Update</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</template>

<script>

Vue.component('ccc-crate-list', {
    template: '#tttCrateList',
    props: ['game'],
    data: function () {
        return {
            kind: '',
            kindList: ['All'],
            included: false,
            disabled: false,
        };
    },
    created: function () {
        let list = this.game.crate.list;
        for (let index = 0; index < list.length; index++) {
            const crate = list[index];
            if (this.kindList.indexOf(crate.kind) == -1) {
                this.kindList.push(crate.kind);
            }
        }
        this.kind = this.kindList[1];
    },
    computed: {
        list: function () {
            let list = this.game.crate.list;
            if (this.kind == 'All') {
                return list;
            }

            let array = [];
            for (let index = 0; index < list.length; index++) {
                const crate = list[index];
                if (this.kind == crate.kind) {
                    array.push(crate);
                }
            }
            return array;
        }
    },
    methods: {
        add: function () {
            let name = prompt('Please enter the Crate name');
            if (name) {
                let crate = this.game.crate.create();
                crate.name = name;
                crate.kind = this.kind;
                crate.custom = true;
                this.game.crate.push(crate);
            }
        },
        remove: function (crate) {
            if (confirm('Are you sure?')) {
                this.game.crate.remove(crate);
            }
        },
        load: function (event) {
            let me = this;
            let file = event.target.files[0];
            read(file, function (json) {
                me.game.load(json);
            });
        },
        update: function () {
            this.game.update();
        },
        save: function () {
            download('loot.json', this.game.save());
        },
        deploy: function () {
            try {
                let ini = this.game.deploy();
                showInput({
                    message: 'Paste this into Game.ini',
                    text: ini
                });
            } catch (e) {
                alert(e);
            }
        },
        change: function (key) {
            let string = prompt('Please enter a number', 1);
            let amount = parseInt(string);
            let array = this.list;
            for (let index = 0; index < array.length; index++) {
                const crate = array[index];
                crate[key] = amount;
            }
        },
        edit: function (crate) {
            CrateEH.$emit('edit', crate);
        },
        copy: function (crate) {
            showChoose({
                message: 'Please select the source crate',
                list: this.notEmpty(),
                yesCB: function (selected) {
                    if (Object.is(crate, selected)) {
                        alert('Same crate!');
                        return;
                    }
                    crate.bag.load(selected.bag);
                }
            });
        },
        include: function () {
            this.included = !this.included;
            for (let index = 0; index < this.list.length; index++) {
                const crate = this.list[index];
                crate.included = this.included;
            }
        },
        disable: function () {
            this.disabled = !this.disabled;
            for (let index = 0; index < this.list.length; index++) {
                const crate = this.list[index];
                crate.disabled = this.disabled;
            }
        },
        notEmpty: function () {
            let array = [];
            let list = this.game.crate.list;
            for (let index = 0; index < list.length; index++) {
                const crate = list[index];
                if (crate.bag.list.length) {
                    array.push(crate);
                }
            }
            return array;
        }
    }
});

</script>

<template id="tttDialogue">
    <div class="dialogue">
        <div class="layer"></div>
        <div class="panel" v-bind:class="{small: small}">
            <div class="margin3">
                <slot name="header"></slot>
            </div>
            <div class="margin3">
                <slot name="body"></slot>
            </div>
            <div class="margin3">
                <slot name="footer"></slot>
            </div>
        </div>
    </div>
</template>

<script>
    
Vue.component('ccc-dialogue', {
    template: '#tttDialogue',
    props: ['small']
});

</script>

<template id="tttInput">
    <ccc-dialogue v-bind:small="input.small">
        <template slot="header">
            <h4>{{input.message}}</h4>
        </template>
        <template slot="body">
            <textarea cols="111" rows="16">{{input.text}}</textarea>
        </template>
        <template slot="footer">
            <button v-on:click="yes" class="btn btn-success" type="button">V</button>
            <button v-on:click="no" class="btn btn-danger" type="button">X</button>
        </template>
    </ccc-dialogue>
</template>

<script>
    
const Input = {
    visible: false,
    small: false,
    message: '',
    text: '',
    yesCB: null,
    noCB: null
}

function showInput(data) {
    Input.small = false;
    Input.text = '';
    Input.yesCB = null;
    Input.noCB = null;
    for (const key in data) {
        Input[key] = data[key];
    }
    Input.visible = true;
}

Vue.component('ccc-input', {
    template: '#tttInput',
    props: ['input'],
    methods: {
        yes: function () {
            if ('function' == typeof this.input.yesCB) {
                this.input.yesCB(this.input.text);
            }
            this.input.visible = false;
        },
        no: function () {
            if ('function' == typeof this.input.noCB) {
                this.input.noCB(this.input.text);
            }
            this.input.visible = false;
        }
    }
});

</script>

<template id="tttItemList">
    <div class="col-sm-12">
        <table class="table table-bordered">
            <caption>
                <div class="form-inline">
                    <span>Category:</span>
                    <select v-model="ItemFilter.kind" class="form-control">
                        <option v-for="name in ItemFilter.kindList" v-bind:value="name">{{name}}</option>
                    </select>
                </div>
            </caption>
            <thead>
                <tr>
                    <th class="col-sm-4">Name</th>
                    <th class="col-sm-8">Class</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="item in ItemFilter.list">
                    <td>
                        <div v-if="item.custom" class="form-inline">
                            <input v-model="item.name" type="text" class="form-control">
                            <button v-on:click="remove(item)" class="btn btn-danger btn-sm">X</button>
                        </div>
                        <span v-else>{{item.name}}</span>
                    </td>
                    <td>
                        <input v-if="item.custom" v-model="item.class" type="text" class="form-control">
                        <span v-else>{{item.class}}</span>
                    </td>
                </tr>
                <!-- <tr>
                    <td>
                        <button v-on:click="add" class="btn btn-info">+</button>
                    </td>
                    <td></td>
                </tr> -->
            </tbody>
        </table>
    </div>
</template>

<script>
    
Vue.component('ccc-item-list', {
    template: '#tttItemList',
    props: ['game'],
    data: function () {
        return {
            ItemFilter: ItemFilter
        };
    },
    methods: {
        add: function () {
            let name = prompt('Please enter the Item name');
            if (name) {
                let item = this.game.item.create();
                item.name = name;
                item.kind = this.ItemFilter.kind;
                item.blueprint = true;
                item.custom = true;
                this.game.item.push(item);
            }
        },
        remove: function (item) {
            if (confirm('Are you sure?')) {
                this.game.item.remove(item);
                this.ItemFilter.item.remove(item);
            }
        }
    }
});

</script>

<div id='app'>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button aria-controls="bs-navbar" aria-expanded="false" class="collapsed navbar-toggle" data-target="#bs-navbar" data-toggle="collapse"
                    type="button">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand">Loot</a>
            </div>
            <nav class="collapse navbar-collapse" id="bs-navbar">
                <ul class="nav navbar-nav">
                    <li v-bind:class="{active: -1 != tab.indexOf('crate')}">
                        <a href="#" v-on:click="tab = 'cratelist'">Crate</a>
                    </li>
                    <li v-bind:class="{active: -1 != tab.indexOf('bag')}">
                        <a href="#" v-on:click="tab = 'baglist'">ItemSet</a>
                    </li>
                    <li v-bind:class="{active: 'itemlist' == tab}">
                        <a href="#" v-on:click="tab = 'itemlist'">Item</a>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="https://github.com/GooGee/Loot">GitHub</a>
                    </li>
                </ul>
            </nav>
        </div>
    </nav>

    <div v-if="ready" class="container">
        <div class="row">
            <ccc-crate-list v-show="'cratelist'==tab" v-bind:game="game"></ccc-crate-list>
            <ccc-crate v-if="'crate'==tab" v-bind:game="game" v-bind:crate="crate"></ccc-crate>
            <ccc-bag-list v-show="'baglist'==tab" v-bind:game="game"></ccc-bag-list>
            <ccc-bag v-if="'bag'==tab" v-bind:game="game" v-bind:bag="bag"></ccc-bag>
            <ccc-item-list v-show="'itemlist'==tab" v-bind:game="game"></ccc-item-list>
        </div>
    </div>

    <ccc-choose v-show="choose.visible" v-bind:choose="choose"></ccc-choose>
    <ccc-input v-show="input.visible" v-bind:input="input"></ccc-input>
</div>

<script>
    
const CrateEH = new Vue();
const BagEH = new Vue();
const ItemFilter = new Vue({
    data: {
        kind: '',
        kindList: ['All'],
        item: null
    },
    created: function () {
        this.item = new List(Facade.Entry);
        this.item.load(ItemList);

        let list = this.item.list;
        for (let index = 0; index < list.length; index++) {
            const item = list[index];
            if (this.kindList.indexOf(item.kind) == -1) {
                this.kindList.push(item.kind);
            }
        }
        this.kind = this.kindList[1];
    },
    computed: {
        list: function () {
            let list = this.item.list;
            if (this.kind == 'All') {
                return list;
            }

            let array = [];
            for (let index = 0; index < list.length; index++) {
                const item = list[index];
                if (this.kind == item.kind) {
                    array.push(item);
                }
            }
            return array;
        }
    }
});

const vvv = new Vue({
    el: '#app',
    data: {
        ready: false,
        tab: 'index',
        game: null,
        crate: null,
        bag: null,
        choose: Choose,
        input: Input,
    },
    created: function () {
        let game = new Facade.Game();
        game.crate.load(CrateList);
        game.bag.load(BagList);

        let me = this;
        CrateEH.$on('edit', function (crate) {
            me.crate = crate;
            me.tab = 'crate';
        });
        BagEH.$on('edit', function (bag) {
            me.bag = bag;
            me.tab = 'bag';
        });

        this.game = game;
        this.tab = 'cratelist';
        this.ready = true;
    }
});

</script>

</body>

</html>